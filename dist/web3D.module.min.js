import{Vector3 as Je,Color as et,WebGLRenderer as ro,PerspectiveCamera as so}from"three";import{Vector2 as ho,Vector3 as At,Raycaster as go,Quaternion as bo}from"three";import{EventDispatcher as xt,MOUSE as z,Quaternion as ke,Spherical as ze,TOUCH as _,Vector2 as O,Vector3 as x,Plane as vt,Ray as Tt,MathUtils as St}from"three";var _e={type:"change"},le={type:"start"},Ye={type:"end"},Q=new Tt,Ve=new vt,Ot=Math.cos(70*St.DEG2RAD),J=class extends xt{constructor(n,a){super(),this.object=n,this.domElement=a,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new x,this.cursor=new x,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:z.ROTATE,MIDDLE:z.DOLLY,RIGHT:z.PAN},this.touches={ONE:_.ROTATE,TWO:_.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return c.phi},this.getAzimuthalAngle=function(){return c.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",ce),this._domElementKeyEvents=t},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",ce),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(_e),e.update(),s=o.NONE},this.update=function(){let t=new x,i=new ke().setFromUnitVectors(n.up,new x(0,1,0)),l=i.clone().invert(),u=new x,M=new ke,I=new x,v=2*Math.PI;return function(Et=null){let Ie=e.object.position;t.copy(Ie).sub(e.target),t.applyQuaternion(i),c.setFromVector3(t),e.autoRotate&&s===o.NONE&&G(it(Et)),e.enableDamping?(c.theta+=p.theta*e.dampingFactor,c.phi+=p.phi*e.dampingFactor):(c.theta+=p.theta,c.phi+=p.phi);let A=e.minAzimuthAngle,R=e.maxAzimuthAngle;isFinite(A)&&isFinite(R)&&(A<-Math.PI?A+=v:A>Math.PI&&(A-=v),R<-Math.PI?R+=v:R>Math.PI&&(R-=v),A<=R?c.theta=Math.max(A,Math.min(R,c.theta)):c.theta=c.theta>(A+R)/2?Math.max(A,c.theta):Math.min(R,c.theta)),c.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,c.phi)),c.makeSafe(),e.enableDamping===!0?e.target.addScaledVector(h,e.dampingFactor):e.target.add(h),e.target.sub(e.cursor),e.target.clampLength(e.minTargetRadius,e.maxTargetRadius),e.target.add(e.cursor);let U=!1;if(e.zoomToCursor&&W||e.object.isOrthographicCamera)c.radius=re(c.radius);else{let L=c.radius;c.radius=re(c.radius*d),U=L!=c.radius}if(t.setFromSpherical(c),t.applyQuaternion(l),Ie.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(p.theta*=1-e.dampingFactor,p.phi*=1-e.dampingFactor,h.multiplyScalar(1-e.dampingFactor)):(p.set(0,0,0),h.set(0,0,0)),e.zoomToCursor&&W){let L=null;if(e.object.isPerspectiveCamera){let X=t.length();L=re(X*d);let $=X-L;e.object.position.addScaledVector(j,$),e.object.updateMatrixWorld(),U=!!$}else if(e.object.isOrthographicCamera){let X=new x(E.x,E.y,0);X.unproject(e.object);let $=e.object.zoom;e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/d)),e.object.updateProjectionMatrix(),U=$!==e.object.zoom;let Ne=new x(E.x,E.y,0);Ne.unproject(e.object),e.object.position.sub(Ne).add(X),e.object.updateMatrixWorld(),L=t.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),e.zoomToCursor=!1;L!==null&&(this.screenSpacePanning?e.target.set(0,0,-1).transformDirection(e.object.matrix).multiplyScalar(L).add(e.object.position):(Q.origin.copy(e.object.position),Q.direction.set(0,0,-1).transformDirection(e.object.matrix),Math.abs(e.object.up.dot(Q.direction))<Ot?n.lookAt(e.target):(Ve.setFromNormalAndCoplanarPoint(e.object.up,e.target),Q.intersectPlane(Ve,e.target))))}else if(e.object.isOrthographicCamera){let L=e.object.zoom;e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/d)),L!==e.object.zoom&&(e.object.updateProjectionMatrix(),U=!0)}return d=1,W=!1,U||u.distanceToSquared(e.object.position)>m||8*(1-M.dot(e.object.quaternion))>m||I.distanceToSquared(e.target)>m?(e.dispatchEvent(_e),u.copy(e.object.position),M.copy(e.object.quaternion),I.copy(e.target),!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",De),e.domElement.removeEventListener("pointerdown",Oe),e.domElement.removeEventListener("pointercancel",F),e.domElement.removeEventListener("wheel",Ae),e.domElement.removeEventListener("pointermove",se),e.domElement.removeEventListener("pointerup",F),e.domElement.getRootNode().removeEventListener("keydown",Re,{capture:!0}),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",ce),e._domElementKeyEvents=null)};let e=this,o={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},s=o.NONE,m=1e-6,c=new ze,p=new ze,d=1,h=new x,b=new O,w=new O,f=new O,y=new O,P=new O,T=new O,C=new O,D=new O,S=new O,j=new x,E=new O,W=!1,g=[],V={},ne=!1;function it(t){return t!==null?2*Math.PI/60*e.autoRotateSpeed*t:2*Math.PI/60/60*e.autoRotateSpeed}function Z(t){let i=Math.abs(t*.01);return Math.pow(.95,e.zoomSpeed*i)}function G(t){p.theta-=t}function q(t){p.phi-=t}let ge=function(){let t=new x;return function(l,u){t.setFromMatrixColumn(u,0),t.multiplyScalar(-l),h.add(t)}}(),be=function(){let t=new x;return function(l,u){e.screenSpacePanning===!0?t.setFromMatrixColumn(u,1):(t.setFromMatrixColumn(u,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(l),h.add(t)}}(),N=function(){let t=new x;return function(l,u){let M=e.domElement;if(e.object.isPerspectiveCamera){let I=e.object.position;t.copy(I).sub(e.target);let v=t.length();v*=Math.tan(e.object.fov/2*Math.PI/180),ge(2*l*v/M.clientHeight,e.object.matrix),be(2*u*v/M.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(ge(l*(e.object.right-e.object.left)/e.object.zoom/M.clientWidth,e.object.matrix),be(u*(e.object.top-e.object.bottom)/e.object.zoom/M.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function ie(t){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?d/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ye(t){e.object.isPerspectiveCamera||e.object.isOrthographicCamera?d*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ae(t,i){if(!e.zoomToCursor)return;W=!0;let l=e.domElement.getBoundingClientRect(),u=t-l.left,M=i-l.top,I=l.width,v=l.height;E.x=u/I*2-1,E.y=-(M/v)*2+1,j.set(E.x,E.y,1).unproject(e.object).sub(e.object.position).normalize()}function re(t){return Math.max(e.minDistance,Math.min(e.maxDistance,t))}function Me(t){b.set(t.clientX,t.clientY)}function at(t){ae(t.clientX,t.clientX),C.set(t.clientX,t.clientY)}function we(t){y.set(t.clientX,t.clientY)}function rt(t){w.set(t.clientX,t.clientY),f.subVectors(w,b).multiplyScalar(e.rotateSpeed);let i=e.domElement;G(2*Math.PI*f.x/i.clientHeight),q(2*Math.PI*f.y/i.clientHeight),b.copy(w),e.update()}function st(t){D.set(t.clientX,t.clientY),S.subVectors(D,C),S.y>0?ie(Z(S.y)):S.y<0&&ye(Z(S.y)),C.copy(D),e.update()}function ct(t){P.set(t.clientX,t.clientY),T.subVectors(P,y).multiplyScalar(e.panSpeed),N(T.x,T.y),y.copy(P),e.update()}function lt(t){ae(t.clientX,t.clientY),t.deltaY<0?ye(Z(t.deltaY)):t.deltaY>0&&ie(Z(t.deltaY)),e.update()}function mt(t){let i=!1;switch(t.code){case e.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?q(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):N(0,e.keyPanSpeed),i=!0;break;case e.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?q(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):N(0,-e.keyPanSpeed),i=!0;break;case e.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?G(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):N(e.keyPanSpeed,0),i=!0;break;case e.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?G(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):N(-e.keyPanSpeed,0),i=!0;break}i&&(t.preventDefault(),e.update())}function Pe(t){if(g.length===1)b.set(t.pageX,t.pageY);else{let i=k(t),l=.5*(t.pageX+i.x),u=.5*(t.pageY+i.y);b.set(l,u)}}function Ee(t){if(g.length===1)y.set(t.pageX,t.pageY);else{let i=k(t),l=.5*(t.pageX+i.x),u=.5*(t.pageY+i.y);y.set(l,u)}}function xe(t){let i=k(t),l=t.pageX-i.x,u=t.pageY-i.y,M=Math.sqrt(l*l+u*u);C.set(0,M)}function ut(t){e.enableZoom&&xe(t),e.enablePan&&Ee(t)}function dt(t){e.enableZoom&&xe(t),e.enableRotate&&Pe(t)}function ve(t){if(g.length==1)w.set(t.pageX,t.pageY);else{let l=k(t),u=.5*(t.pageX+l.x),M=.5*(t.pageY+l.y);w.set(u,M)}f.subVectors(w,b).multiplyScalar(e.rotateSpeed);let i=e.domElement;G(2*Math.PI*f.x/i.clientHeight),q(2*Math.PI*f.y/i.clientHeight),b.copy(w)}function Te(t){if(g.length===1)P.set(t.pageX,t.pageY);else{let i=k(t),l=.5*(t.pageX+i.x),u=.5*(t.pageY+i.y);P.set(l,u)}T.subVectors(P,y).multiplyScalar(e.panSpeed),N(T.x,T.y),y.copy(P)}function Se(t){let i=k(t),l=t.pageX-i.x,u=t.pageY-i.y,M=Math.sqrt(l*l+u*u);D.set(0,M),S.set(0,Math.pow(D.y/C.y,e.zoomSpeed)),ie(S.y),C.copy(D);let I=(t.pageX+i.x)*.5,v=(t.pageY+i.y)*.5;ae(I,v)}function ft(t){e.enableZoom&&Se(t),e.enablePan&&Te(t)}function pt(t){e.enableZoom&&Se(t),e.enableRotate&&ve(t)}function Oe(t){e.enabled!==!1&&(g.length===0&&(e.domElement.setPointerCapture(t.pointerId),e.domElement.addEventListener("pointermove",se),e.domElement.addEventListener("pointerup",F)),!Pt(t)&&(Mt(t),t.pointerType==="touch"?Ce(t):ht(t)))}function se(t){e.enabled!==!1&&(t.pointerType==="touch"?yt(t):gt(t))}function F(t){switch(wt(t),g.length){case 0:e.domElement.releasePointerCapture(t.pointerId),e.domElement.removeEventListener("pointermove",se),e.domElement.removeEventListener("pointerup",F),e.dispatchEvent(Ye),s=o.NONE;break;case 1:let i=g[0],l=V[i];Ce({pointerId:i,pageX:l.x,pageY:l.y});break}}function ht(t){let i;switch(t.button){case 0:i=e.mouseButtons.LEFT;break;case 1:i=e.mouseButtons.MIDDLE;break;case 2:i=e.mouseButtons.RIGHT;break;default:i=-1}switch(i){case z.DOLLY:if(e.enableZoom===!1)return;at(t),s=o.DOLLY;break;case z.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;we(t),s=o.PAN}else{if(e.enableRotate===!1)return;Me(t),s=o.ROTATE}break;case z.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;Me(t),s=o.ROTATE}else{if(e.enablePan===!1)return;we(t),s=o.PAN}break;default:s=o.NONE}s!==o.NONE&&e.dispatchEvent(le)}function gt(t){switch(s){case o.ROTATE:if(e.enableRotate===!1)return;rt(t);break;case o.DOLLY:if(e.enableZoom===!1)return;st(t);break;case o.PAN:if(e.enablePan===!1)return;ct(t);break}}function Ae(t){e.enabled===!1||e.enableZoom===!1||s!==o.NONE||(t.preventDefault(),e.dispatchEvent(le),lt(bt(t)),e.dispatchEvent(Ye))}function bt(t){let i=t.deltaMode,l={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(i){case 1:l.deltaY*=16;break;case 2:l.deltaY*=100;break}return t.ctrlKey&&!ne&&(l.deltaY*=10),l}function Re(t){t.key==="Control"&&(ne=!0,e.domElement.getRootNode().addEventListener("keyup",Le,{passive:!0,capture:!0}))}function Le(t){t.key==="Control"&&(ne=!1,e.domElement.getRootNode().removeEventListener("keyup",Le,{passive:!0,capture:!0}))}function ce(t){e.enabled===!1||e.enablePan===!1||mt(t)}function Ce(t){switch(je(t),g.length){case 1:switch(e.touches.ONE){case _.ROTATE:if(e.enableRotate===!1)return;Pe(t),s=o.TOUCH_ROTATE;break;case _.PAN:if(e.enablePan===!1)return;Ee(t),s=o.TOUCH_PAN;break;default:s=o.NONE}break;case 2:switch(e.touches.TWO){case _.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;ut(t),s=o.TOUCH_DOLLY_PAN;break;case _.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;dt(t),s=o.TOUCH_DOLLY_ROTATE;break;default:s=o.NONE}break;default:s=o.NONE}s!==o.NONE&&e.dispatchEvent(le)}function yt(t){switch(je(t),s){case o.TOUCH_ROTATE:if(e.enableRotate===!1)return;ve(t),e.update();break;case o.TOUCH_PAN:if(e.enablePan===!1)return;Te(t),e.update();break;case o.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;ft(t),e.update();break;case o.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;pt(t),e.update();break;default:s=o.NONE}}function De(t){e.enabled!==!1&&t.preventDefault()}function Mt(t){g.push(t.pointerId)}function wt(t){delete V[t.pointerId];for(let i=0;i<g.length;i++)if(g[i]==t.pointerId){g.splice(i,1);return}}function Pt(t){for(let i=0;i<g.length;i++)if(g[i]==t.pointerId)return!0;return!1}function je(t){let i=V[t.pointerId];i===void 0&&(i=new O,V[t.pointerId]=i),i.set(t.pageX,t.pageY)}function k(t){let i=t.pointerId===g[0]?g[1]:g[0];return V[i]}e.domElement.addEventListener("contextmenu",De),e.domElement.addEventListener("pointerdown",Oe),e.domElement.addEventListener("pointercancel",F),e.domElement.addEventListener("wheel",Ae,{passive:!1}),e.domElement.getRootNode().addEventListener("keydown",Re,{passive:!0,capture:!0}),this.update()}};var Rt={autoRotateSpeed:0,zoomMinDistance:0,zoomToCursor:!1,enableDamping:!1,enablePan:!1};function Ge(r,n){let a=Object.assign(Rt,n),e=new J(r.camera,r.renderer.domElement);e.zoomToCursor=a.zoomToCursor,e.enableDamping=a.enableDamping,e.enablePan=a.enablePan,e.maxDistance=1e4;let o=a.autoRotateSpeed,s=a.zoomMinDistance;return o>0&&(e.autoRotateSpeed=o,e.autoRotate=!0),s>0&&e.addEventListener("change",()=>{if(e.getDistance()<s){let m=new At;e.object.getWorldDirection(m),e.target.add(m.setLength(9))}}),r.playing.animations.updateControls=e.update,e}import{Matrix4 as Xe,Group as It,Color as Nt,EdgesGeometry as kt,LineSegments as zt,BufferGeometry as _t,BoxGeometry as Yt,InstancedMesh as Vt,InstancedBufferGeometry as Gt,InstancedBufferAttribute as Ft,BufferAttribute as Ut}from"three";import{DoubleSide as Lt,MeshLambertMaterial as Fe,MeshStandardMaterial as Ct,LineBasicMaterial as Dt}from"three";var jt={side:Lt,opacity:.6,transparent:!0},ee=new Fe,Ue=new Fe({side:2}),H=new Ct(jt),Y=new Dt({color:"#000"});Y.onBeforeCompile=r=>{r.vertexShader=r.vertexShader.replace("void main() {",`
attribute mat4 matrix;
void main() {`).replace("#include <project_vertex>",`vec4 mvPosition = matrix * vec4( transformed, 1.0 );
      gl_Position = projectionMatrix * modelViewMatrix * mvPosition;`)};var me=new Yt,He=We();function ue(r,n,a){let e=new It().rotateX(-Math.PI/2),o={},s=a?.showEdge||!1,m=a?.grayScale||!1,c=a?.inplace||!1,p=new Xe,d={instance:{box:{color:[],matrix:[]},boxGlass:{color:[],matrix:[]},sloping:{color:[],matrix:[]},slopingGlass:{color:[],matrix:[]}},edge:{boxMatrix:[],slopingMatrix:[]}},h;r.models.forEach(f=>{let y=c?{center:f.centerRelative,rotate:f.rotate}:void 0;for(h in f.data){let P=f.data[h],T=d.instance[h];P.matrices.forEach((C,D)=>{let S=new Xe().fromArray(C);y&&S.premultiply(p.makeRotationZ(y.rotate)).premultiply(p.makeTranslation(...y.center,0)),s&&d.edge[h.includes("box")?"boxMatrix":"slopingMatrix"].push(...S.toArray()),T.matrix.push(S);let j=r.colorMap[P.colors[D]];m&&(j=r.colorMap[j.includes("G")?1:0]);let E=o[j];E||(E=new Nt(j.replace(/ *G$/,"")),o[j]=E),T.color.push(E)})}}),te(e,d.instance.box,me,ee),te(e,d.instance.boxGlass,me,H),te(e,d.instance.sloping,He,Ue),te(e,d.instance.slopingGlass,He,H);let{boxMatrix:b,slopingMatrix:w}=d.edge;if(b.length>0){let f=Ke(me);e.add(Be(f,b,Y))}if(w.length>0){let f=Ke(We());e.add(Be(f,w,Y))}e.name="buildings",n.add(e)}function Ke(r){let n=new kt(r),a=new Gt;return a.setAttribute("position",n.getAttribute("position")),n.dispose(),a}function Be(r,n,a){r.setAttribute("matrix",new Ft(new Float32Array(n),16)),r.instanceCount=n.length/16;let e=new zt(r,a);return e.frustumCulled=!1,e}function te(r,n,a,e){if(n.matrix.length>0){let o=new Vt(a,e,n.matrix.length);n.matrix.forEach((s,m)=>{o.setMatrixAt(m,s),o.setColorAt(m,n.color[m])}),o.castShadow=o.receiveShadow=!0,r.add(o)}}function We(r=.2){let n=new _t,a=[r,.5,1],e=[1-r,.5,1],o=[0,0,0],s=[1,0,0],m=[1,1,0],c=[0,1,0],p=new Float32Array([...s,...a,...o,...s,...e,...a,...c,...e,...m,...c,...a,...e,...o,...a,...c,...m,...e,...s]);return n.setAttribute("position",new Ut(p,3))}import{Group as Xt,Scene as Ht,DirectionalLight as Kt,AmbientLight as Bt,MeshLambertMaterial as Wt,PlaneGeometry as Zt,Mesh as qt,PCFSoftShadowMap as $t,TextureLoader as Qt,Fog as Jt,RepeatWrapping as eo}from"three";var to=-Math.PI/2,K=class{parent;scene;lights;animations;ignored;ground;constructor(n,a=!0){this.parent=n,this.scene=new Ht,this.ignored=new Xt,this.animations={};let e=new Bt("#fff",0),o=new Kt;if(this.lights={directional:o,ambient:e},this.ignored.userData.ignored=!0,this.ignored.add(e,o,o.target),this.scene.add(this.ignored),a){o.shadow.mapSize.set(4096,4096),o.castShadow=!0;let s=o.shadow.camera;s.far=n.options.sunDistance*2;let m=n.renderer.shadowMap;m.type=$t,m.enabled=!0,this.setShadowArea(200,200)}}setShadowArea(n,a){let e=this.lights.directional.shadow.camera;e.bottom=-(e.top=a),e.left=-(e.right=n),e.updateProjectionMatrix()}addGround(n,a){let e=new Wt({color:"#eee",polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:.1}),o=new Zt(n,n).rotateX(to),s=new qt(o,e);s.renderOrder=-1,s.receiveShadow=!0,this.ignored.add(s),a&&new Qt().load(a.pictureURL,m=>{if(this.ground={texture:m,size:n},e.map=m,e.needsUpdate=!0,a.uvMoving){m.wrapS=m.wrapT=eo;let c=a.uvMoving/n;this.animations.uvMovingX=()=>{m.offset.x+=-c}}},m=>console.error("TextureLoader error",a.pictureURL,m))}setPlaneUvMovingX(n){if(this.ground){let{texture:a}=this.ground;this.animations.uvMovingX=()=>{a.offset.x+=n}}}addFog(n,a,e="#fff"){this.scene.fog=new Jt(e,n,a)}};import{Vector3 as B}from"three";function fe(r,n,a,e){r.animations.movingMaterial=()=>{oe.value++},Ze(n,oe,de,oo),Ze(a,oe,de,no),ao(e,oe,de,io)}var de=new B(1,0,0),oe={value:0},oo=pe(`
[[0.778 0.778 0.750] [0.198 0.034 -0.198] [-0.770 -0.492 0.490] [-4.670 -4.970 -5.428]]
`),no=pe(`
[[0.778 0.778 0.750] [0.198 0.034 -0.198] [-0.770 -0.492 0.490] [-4.670 -4.970 -5.428]]
`),io=pe(`
[[1 1 1] [0 0 0] [0 0 0] [0 0 0]]
`),qe=`
uniform float time;
uniform vec3 vect;
varying float bufferRatio;
varying float xPos;

mat4 translate(vec3 v, float t) {
  return mat4(1.0, 0.0, 0.0, 0.0,
              0.0, 1.0, 0.0, 0.0,
              0.0, 0.0, 1.0, 0.0,
              v.x*t, v.y*t, v.z*t, 1.0);
}

`,$e=`
  float range = 1500.0;
  float bufferDistance = 500.0;
  float r2 = range * 2.0;

  bufferRatio = 1.0;
  mvPosition.x -= floor((mvPosition.x + range) / r2) * r2 ;

  float minX = bufferDistance - range;
  float maxX = range - bufferDistance;
  float b = bufferDistance / 2.0;
  xPos = mvPosition.x;
  if (xPos > maxX) {
    bufferRatio = (range - xPos - b) / b;
    if (bufferRatio < 0.0) bufferRatio = 0.0;
  } else if (xPos < minX) {
    bufferRatio = (xPos + range - b) / b;
    if (bufferRatio < 0.0) bufferRatio = 0.0;
  }
  mvPosition.z *= bufferRatio;
`;function pe(r){let n=JSON.parse(r.trim().replace(/ +/g,","));return{v1:{value:new B(...n[0])},v2:{value:new B(...n[1])},v3:{value:new B(...n[2])},v4:{value:new B(...n[3])}}}function Qe(r){return r.replace("uniform vec3 diffuse;",`varying float bufferRatio;
varying float xPos;
uniform vec3 diffuse;
uniform vec3 v1;
uniform vec3 v2;
uniform vec3 v3;
uniform vec3 v4;
      `).replace("void main() {",`vec3 palette( in float t, in vec3 a, in vec3 b, in vec3 c, in vec3 d ) {
return a + b * cos( 6.28318 * (c * t + d) );
}

void main() {
if (bufferRatio < 0.01) discard;`).replace("#include <dithering_fragment>",`#include <dithering_fragment>
vec3 col = palette( xPos/2000.0,v1,v2,v3,v4 );
gl_FragColor = vec4( col, 1.0 );`)}function Ze(r,n,a,e){r.onBeforeCompile=o=>{Object.assign(o.uniforms,e),o.uniforms.time=n,o.uniforms.vect={value:a},o.vertexShader=o.vertexShader.replace("varying vec3 vViewPosition;","varying vec3 vViewPosition;"+qe).replace("#include <project_vertex>",`vec4 mvPosition = vec4( transformed, 1.0 );

        #ifdef USE_BATCHING
          mvPosition = batchingMatrix * mvPosition;
        #endif

        #ifdef USE_INSTANCING
          mvPosition = instanceMatrix * mvPosition;
        #endif

        mvPosition = translate( vect, time ) * mvPosition;

        ${$e}

        gl_Position = projectionMatrix * modelViewMatrix * mvPosition;`),o.fragmentShader=Qe(o.fragmentShader)}}function ao(r,n,a,e){r.depthWrite=!1,r.forceSinglePass=!0,r.onBeforeCompile=o=>{Object.assign(o.uniforms,e),o.uniforms.time=n,o.uniforms.vect={value:a},o.vertexShader=o.vertexShader.replace("void main() {",`
${qe}
attribute mat4 matrix;
void main() {`).replace("#include <project_vertex>",`vec4 mvPosition = vec4( transformed, 1.0 );

        #ifdef USE_BATCHING
          mvPosition = batchingMatrix * mvPosition;
        #endif

        #ifdef USE_INSTANCING
          mvPosition = instanceMatrix * mvPosition;
        #endif

        mvPosition = translate( vect, time ) * matrix * mvPosition;

        ${$e}

        gl_Position = projectionMatrix * modelViewMatrix * mvPosition;`),o.fragmentShader=Qe(o.fragmentShader)}}var co={cameraPosition:[900,900,900],sunDistance:1e4,shadow:!0,time:10,lightColor:[{hour:5,color:"#116",directional:0,ambient:0},{hour:6,color:"#f60",directional:.6,ambient:.2},{hour:9,color:"#fff",directional:2,ambient:.6},{hour:12,color:"#fff",directional:2,ambient:.6},{hour:16,color:"#fff",directional:2,ambient:.6},{hour:18,color:"#d33",directional:.6,ambient:.2},{hour:19,color:"#116",directional:.1,ambient:.1},{hour:24,color:"#000",directional:0,ambient:0}]},he=class{renderer;camera;constrols;views;playing;sunPosition;options;parent;envTexture;constructor(n,a){let e=document.querySelector(n);if(!e)throw"ERROR: invalid parentCSSID";let o=document.createElement("canvas");e.appendChild(o),this.parent=e,this.options=Object.assign(co,a),(this.renderer=new ro({antialias:!0,canvas:o})).setPixelRatio(window.devicePixelRatio),this.playing=new K(this,this.options.shadow),this.views=[this.playing],this.camera=new so(45,1,1,1e9),this.camera.position.set(...this.options.cameraPosition),this.constrols=Ge(this),this.sunPosition=new Je,this.setTime(this.options.time),this.resizeScene(),window.addEventListener("resize",()=>this.resizeScene()),ot(this)}setMovingMaterial(){fe(this.playing,ee,H,Y)}setTime(n,a=!0){n=n%24,(a?[this.playing]:this.views).forEach(o=>{let s=o.lights.directional,m=o.lights.ambient,c,p,d,h=this.options.lightColor;h.find((b,w)=>{if(b.hour>n){let f=h[(w===0?h.length:w)-1],y=(n-f.hour)/(b.hour-f.hour);d=new et(f.color).lerp(new et(b.color),y),p=f.directional+(b.directional-f.directional)*y,c=f.ambient+(b.ambient-f.ambient)*y,s.color.set(d),s.intensity=p,m.color.set(d),m.intensity=c,this.renderer.setClearColor(d,(1-c)*.9);let P=Math.PI*(Math.cos(Math.PI*2*(n/24))+1),T=-Math.PI*n/12;return this.sunPosition.setFromSphericalCoords(this.options.sunDistance,P<0?0:P,T),s.position.copy(this.sunPosition),s.lookAt(new Je),!0}return!1})})}resizeScene(){let{innerWidth:n,innerHeight:a}=window;this.renderer.setSize(n,a),this.camera.aspect=n/a,this.camera.updateProjectionMatrix()}clean(n=!0){n?tt(this.playing):this.views.forEach(tt)}refresh(n,a){return new Promise((e,o)=>{this.clean();let s={floorArea:0,maxFloors:0},m=0;ue(n,this.playing.scene,a),n.models.forEach(c=>{let p=c.params.height,{floors:d,floorArea:h}=c.info;s.floorArea+=h*d,s.maxFloors<d&&(s.maxFloors=d),m<p&&(m=p)}),e(s)})}};function ot(r){let n=r.playing;r.renderer.render(n.scene,r.camera);for(let a in n.animations)n.animations[a]();document.body.contains(r.renderer.domElement)&&requestAnimationFrame(()=>ot(r))}function tt(r){r.scene.children.map(a=>a).forEach(a=>{a.userData.ignored||(a.removeFromParent(),nt(a))})}function nt(r){r.children&&r.children.forEach(nt),r.material&&r.material.dispose(),r.geometry&&r.geometry.dispose()}export{he as default};
